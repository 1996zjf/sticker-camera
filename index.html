<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI æŠ å›¾ - æ€¥æ•‘è°ƒè¯•ç‰ˆ</title>
    <style>
        /* === 1. åŸºç¡€æ ·å¼ (é˜²æ­¢ç•Œé¢å´©å) === */
        body { 
            background: #2d3436; color: white; margin: 0; padding: 10px; 
            font-family: sans-serif; text-align: center; overflow-x: hidden;
        }
        
        /* å¼ºåˆ¶é™åˆ¶è§†é¢‘å¤§å°ï¼Œè§£å†³å–æ™¯æ¡†å·¨å¤§é—®é¢˜ */
        .camera-wrapper { 
            width: 100%; 
            max-width: 600px; 
            height: 60vh; /* é™åˆ¶é«˜åº¦ */
            background: #000; 
            margin: 10px auto; 
            border-radius: 12px; 
            overflow: hidden; 
            position: relative; 
            border: 2px solid #6c5ce7;
        }
        
        video { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; /* ç¡®ä¿ç”»é¢å®Œæ•´ */
        }
        
        canvas { max-width: 100%; display: none; border-radius: 12px; }

        /* === 2. æ—¥å¿—æ¡† (å¼ºåˆ¶ç½®é¡¶æ˜¾ç¤º) === */
        #console-box {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 150px;
            background: rgba(0, 0, 0, 0.9);
            color: #00b894;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            overflow-y: scroll;
            text-align: left;
            z-index: 9999;
            border-top: 2px solid #fab1a0;
        }

        .btn {
            padding: 15px 40px; font-size: 18px; border-radius: 50px;
            background: #6c5ce7; color: white; border: none; font-weight: bold;
            margin-bottom: 160px; /* ç»™æ—¥å¿—æ¡†ç•™ä½ç½® */
        }
        .btn:disabled { background: #636e72; }
    </style>
</head>
<body>

    <h3>ğŸ” æ·±åº¦è°ƒè¯•æ¨¡å¼</h3>
    <div class="camera-wrapper">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="resultCanvas"></canvas>
    </div>

    <button id="captureBtn" class="btn" onclick="runCapture()">ğŸ“¸ æ‹ç…§</button>

    <!-- æ—¥å¿—å®¹å™¨ -->
    <div id="console-box">æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–...<br></div>

    <!-- === è„šæœ¬åŒºåŸŸ === -->
    <script>
        // 1. ç«‹å³åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ (ä¿è¯ä¸æŠ¥é”™)
        const logBox = document.getElementById('console-box');
        function log(msg, isError = false) {
            const time = new Date().toLocaleTimeString();
            const color = isError ? '#ff7675' : '#00b894';
            logBox.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
            console.log(msg);
        }
        
        // 2. å…¨å±€é”™è¯¯æ•è· (ä¸“é—¨æŠ“å– "Script error" æˆ– 404)
        window.onerror = function(message, source, lineno, colno, error) {
            log(`âŒ å…¨å±€é”™è¯¯: ${message}`, true);
            log(`ğŸ“ ä½ç½®: ${source}:${lineno}`, true);
            return true;
        };
        
        // 3. æŒ‚è½½å…¨å±€ logï¼Œé˜²æ­¢ module æ‰¾ä¸åˆ°
        window.appLog = log;
    </script>

    <!-- === 4. å°è¯•å¯¼å…¥æ¨¡å— === -->
    <script type="module">
        try {
            window.appLog("ğŸ”„ æ­£åœ¨å°è¯•å¯¼å…¥ ./imgly.js ...");
            
            // å°è¯•å¯¼å…¥æ‰€æœ‰å†…å®¹
            import * as Module from './imgly.js';
            
            window.appLog("âœ… å¯¼å…¥è¯­å¥æ‰§è¡ŒæˆåŠŸï¼");
            window.appLog("ğŸ“‚ æ¨¡å—åŒ…å«ä»¥ä¸‹å¯¼å‡º: " + Object.keys(Module).join(', '));

            // æ™ºèƒ½å¯»æ‰¾å…¥å£å‡½æ•°
            // 1.7.0/1.4.0 å¯èƒ½å¯¼å‡ºçš„åå­—ï¼šremoveBackground, imglyRemoveBackground, default
            const mainFn = Module.removeBackground || Module.default || Module.imglyRemoveBackground;

            if (mainFn) {
                window.imglyLib = mainFn;
                window.appLog("ğŸ‰ æˆåŠŸé”å®šæ ¸å¿ƒå‡½æ•°ï¼å¯ä»¥æ‹ç…§äº†ã€‚");
            } else {
                window.appLog("âš ï¸ è­¦å‘Šï¼šæ¨¡å—å·²åŠ è½½ï¼Œä½†æ²¡æ‰¾åˆ°å…¥å£å‡½æ•°ã€‚", true);
                window.appLog("è¯·æŸ¥çœ‹ä¸Šæ–¹å¯¼å‡ºçš„åå­—ï¼Œçœ‹å“ªä¸ªåƒã€‚", true);
            }

        } catch (e) {
            window.appLog("âŒ æ¨¡å—å¯¼å…¥ä¸¥é‡å¤±è´¥ï¼", true);
            window.appLog("åŸå› : " + e.message, true);
            if(e.message.includes('404')) {
                window.appLog("ğŸ‘‰ ä½ çš„ imgly.js æ–‡ä»¶åå¯èƒ½ä¸å¯¹ï¼Œæˆ–è€…æ²¡ä¼ ä¸Šå»ã€‚", true);
            }
        }
    </script>

    <!-- === 5. ä¸šåŠ¡é€»è¾‘ === -->
    <script>
        const video = document.getElementById('video');
        
        // å¯åŠ¨æ‘„åƒå¤´
        async function initCam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = stream;
                log("ğŸ¥ æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ");
            } catch(e) {
                log("âŒ æ‘„åƒå¤´å¤±è´¥: " + e.message, true);
            }
        }
        initCam();

        // æ‹ç…§å¤„ç†
        window.runCapture = async function() {
            const btn = document.getElementById('captureBtn');
            
            if (!window.imglyLib) {
                log("â›” æ— æ³•æ‹ç…§ï¼šJS åº“æœªåŠ è½½æˆåŠŸã€‚è¯·çœ‹ä¸Šæ–¹çº¢å­—é”™è¯¯ã€‚", true);
                alert("JS åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥åº•éƒ¨æ—¥å¿—");
                return;
            }

            btn.disabled = true;
            btn.innerText = "è®¡ç®—ä¸­...";
            log("ğŸš€ å¼€å§‹ AI å¤„ç†...");

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            try {
                const blob = await new Promise(r => canvas.toBlob(r));
                
                // é…ç½®ï¼šå‘Šè¯‰å®ƒå»å½“å‰ç›®å½•æ‰¾ resources.json
                const config = {
                    publicPath: './', 
                    debug: true,
                    progress: (key, cur, total) => {
                        if(total) log(`ğŸ“¥ åŠ è½½: ${Math.round(cur/total*100)}%`);
                    }
                };

                const result = await window.imglyLib(blob, config);
                
                log("âœ¨ å¤„ç†å®Œæˆï¼");
                const resCanvas = document.getElementById('resultCanvas');
                resCanvas.width = result.width;
                resCanvas.height = result.height;
                resCanvas.getContext('2d').drawImage(result, 0, 0);
                
                video.style.display = 'none';
                resCanvas.style.display = 'block';
                btn.style.display = 'none';

            } catch(e) {
                log("âŒ å¤„ç†å‡ºé”™: " + e.message, true);
                btn.disabled = false;
                btn.innerText = "é‡è¯•";
            }
        }
    </script>
</body>
</html>
