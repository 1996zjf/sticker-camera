<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯Šæ–­æ¨¡å¼ - è´´çº¸ç›¸æœº</title>
    <style>
        :root { --primary: #6c5ce7; --bg: #dfe6e9; }
        body { font-family: sans-serif; background: var(--bg); padding: 10px; text-align: center; }
        
        /* è°ƒè¯•æ—¥å¿—åŒº */
        #debug-log {
            width: 90%;
            height: 100px;
            background: #2d3436;
            color: #55efc4;
            font-family: monospace;
            font-size: 12px;
            overflow-y: scroll;
            text-align: left;
            padding: 10px;
            margin: 10px auto;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        .camera-wrapper { 
            position: relative; width: 100%; height: 300px; 
            background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 10px;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        #resultCanvas { max-width: 100%; height: auto; display: none; border-radius: 10px; border: 2px dashed #b2bec3; }

        button { 
            padding: 12px 20px; margin: 5px; border: none; border-radius: 5px; 
            font-size: 16px; font-weight: bold; background: var(--primary); color: white; 
        }
        button:disabled { background: #b2bec3; }
        
        #status { margin-bottom: 5px; font-weight: bold; color: #d63031; }
        .ready { color: #00b894 !important; }
    </style>
</head>
<body>
    <h3>ğŸ”§ æ•…éšœæ’æŸ¥æ¨¡å¼</h3>
    <div id="status">ğŸ”´ ç­‰å¾… AI å¼•æ“...</div>
    
    <div class="camera-wrapper">
        <video id="video" autoplay playsinline muted></video>
    </div>
    <canvas id="resultCanvas"></canvas>

    <div>
        <button id="startCamBtn" onclick="initCamera()">ğŸ¥ æ‰‹åŠ¨å¯åŠ¨æ‘„åƒå¤´</button>
        <button id="captureBtn" onclick="handleCapture()" disabled>ğŸ“¸ æ‹ç…§</button>
        <button onclick="location.reload()">ğŸ”„ åˆ·æ–°é¡µé¢</button>
    </div>

    <p style="font-size:12px">ğŸ‘‡ å¦‚æœé»‘å±ï¼Œè¯·æˆªå›¾ä¸‹é¢çš„æ–‡å­—å‘ç»™æˆ‘ ğŸ‘‡</p>
    <div id="debug-log">=== ç³»ç»Ÿæ—¥å¿— ===<br></div>

    <!-- ES Module é€»è¾‘ -->
    <script type="module">
        import imglyRemoveBackground from 'https://esm.sh/@imgly/background-removal@1.3.0';

        function log(msg) {
            const box = document.getElementById('debug-log');
            const time = new Date().toLocaleTimeString();
            box.innerHTML += `[${time}] ${msg}<br>`;
            box.scrollTop = box.scrollHeight;
            console.log(msg);
        }
        
        // æš´éœ²ç»™å…¨å±€
        window.logToScreen = log;

        window.runAI = async (blob) => {
            log("ğŸš€ å¼€å§‹ AI å¤„ç†...");
            return await imglyRemoveBackground(blob, {
                publicPath: 'https://esm.sh/@imgly/background-removal-data@1.3.0/dist/',
                debug: true,
                progress: (key, current, total) => {
                   if(current === total) log(`ğŸ“¦ æ¨¡å‹æ¨¡å— ${key} ä¸‹è½½å®Œæˆ`);
                }
            });
        };

        // é€šçŸ¥ç•Œé¢ AI å·²åŠ è½½
        const status = document.getElementById('status');
        status.innerText = "ğŸŸ¢ AI å¼•æ“å°±ç»ªï¼Œè¯·å¯åŠ¨æ‘„åƒå¤´";
        status.classList.add('ready');
        log("âœ… æ ¸å¿ƒåº“åŠ è½½æˆåŠŸ (esm.sh)");
    </script>

    <!-- å¸¸è§„é€»è¾‘ -->
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('resultCanvas');
        const ctx = canvas.getContext('2d');
        const captureBtn = document.getElementById('captureBtn');
        const startCamBtn = document.getElementById('startCamBtn');

        // ç®€å•çš„æ—¥å¿—åŒ…è£…
        function debug(msg) {
            if(window.logToScreen) window.logToScreen(msg);
            else console.log(msg);
        }

        // 1. å¯åŠ¨æ‘„åƒå¤´ (å¢å¼ºç‰ˆ)
        async function initCamera() {
            debug("ğŸ”„ æ­£åœ¨å°è¯•å¯åŠ¨æ‘„åƒå¤´...");
            
            try {
                // æ–¹æ¡ˆ A: å°è¯•è¯·æ±‚åç½®
                debug("å°è¯•æ–¹æ¡ˆ A: åç½®æ‘„åƒå¤´");
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 } 
                    },
                    audio: false 
                });
                handleStream(stream);
            } catch (err) {
                debug("âŒ æ–¹æ¡ˆ A å¤±è´¥: " + err.message);
                debug("å°è¯•æ–¹æ¡ˆ B: ä»»æ„æ‘„åƒå¤´ (å‰ç½®/ç”µè„‘)");
                
                try {
                    // æ–¹æ¡ˆ B: åªè¦æ˜¯ä¸ªæ‘„åƒå¤´å°±è¡Œ
                    const streamFallback = await navigator.mediaDevices.getUserMedia({ 
                        video: true, audio: false 
                    });
                    handleStream(streamFallback);
                } catch (err2) {
                    debug("âŒ ä¸¥é‡é”™è¯¯: æ— æ³•å¯åŠ¨ä»»ä½•æ‘„åƒå¤´");
                    debug("åŸå› : " + err2.name + " - " + err2.message);
                    alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼è¯·çœ‹ä¸‹æ–¹æ—¥å¿—ã€‚\nå¦‚æœæ˜¯ iPhoneï¼Œè¯·åœ¨ Safari è®¾ç½®ä¸­å…è®¸ç›¸æœºè®¿é—®ã€‚");
                }
            }
        }

        function handleStream(stream) {
            debug("âœ… æ‘„åƒå¤´æµè·å–æˆåŠŸ");
            video.srcObject = stream;
            // å¿…é¡»æ‰‹åŠ¨è§¦å‘ playï¼Œé˜²æ­¢æœ‰äº›æµè§ˆå™¨æš‚åœ
            video.play().then(() => {
                debug("â–¶ï¸ è§†é¢‘å¼€å§‹æ’­æ”¾");
                startCamBtn.style.display = 'none';
                captureBtn.disabled = false;
            }).catch(e => {
                debug("âš ï¸ è§†é¢‘æ’­æ”¾è¢«é˜»æ­¢: " + e.message);
                debug("è¯·ç‚¹å‡»å±å¹•å°è¯•äº’åŠ¨");
            });
        }

        // 2. æ‹ç…§é€»è¾‘
        async function handleCapture() {
            if (!window.runAI) {
                alert("AI è¿˜åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨å...");
                return;
            }
            
            debug("ğŸ“· ç‚¹å‡»äº†æ‹ç…§");
            captureBtn.disabled = true;
            captureBtn.innerText = "å¤„ç†ä¸­...";

            // æˆªå›¾
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            if(canvas.width === 0) {
                debug("âŒ é”™è¯¯: è§†é¢‘ç”»é¢å®½åº¦ä¸º0ï¼Œæ‘„åƒå¤´æœªæ­£å¸¸å·¥ä½œ");
                captureBtn.disabled = false;
                return;
            }
            
            ctx.drawImage(video, 0, 0);
            
            try {
                const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
                debug("ğŸ–¼ï¸ å›¾ç‰‡å·²æˆªå–ï¼Œå¤§å°: " + blob.size);
                
                // è°ƒç”¨ AI
                const imageBitmap = await window.runAI(blob);
                debug("âœ¨ AI æŠ å›¾å®Œæˆï¼å‡†å¤‡æ¸²æŸ“");

                await drawSticker(imageBitmap);
                
                video.style.display = 'none';
                canvas.style.display = 'block';
                captureBtn.style.display = 'none';
                debug("âœ… æµç¨‹ç»“æŸ");
            } catch (error) {
                debug("âŒ å¤„ç†å‡ºé”™: " + error.message);
                alert("å‡ºé”™: " + error.message);
                captureBtn.disabled = false;
                captureBtn.innerText = "é‡è¯•";
            }
        }

        async function drawSticker(imageBitmap) {
            // æ¸…ç©ºç”»å¸ƒé‡æ–°ç”»
            const img = imageBitmap; // bitmap å¯ä»¥ç›´æ¥ç”»
            canvas.width = img.width;
            canvas.height = img.height;

            ctx.filter = 'saturate(1.2) contrast(1.1)';
            
            // æè¾¹
            const border = Math.max(10, img.width * 0.02);
            ctx.shadowColor = 'white';
            ctx.shadowBlur = 0;
            const steps = 8;
            for(let i=0; i<steps; i++) {
                const a = (i/steps)*2*Math.PI;
                ctx.shadowOffsetX = Math.cos(a)*border;
                ctx.shadowOffsetY = Math.sin(a)*border;
                ctx.drawImage(img, 0, 0);
            }
            ctx.shadowColor = 'transparent';
            ctx.filter = 'none';
            ctx.drawImage(img, 0, 0);
        }

        // é¡µé¢åŠ è½½åå°è¯•è‡ªåŠ¨å¯åŠ¨
        window.onload = () => {
            debug("é¡µé¢åŠ è½½å®Œæˆï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œæˆ–è‡ªåŠ¨å¯åŠ¨...");
            // å»¶æ—¶ä¸€ç‚¹ç‚¹è‡ªåŠ¨å¯åŠ¨ï¼Œç»™ AI åŠ è½½ç•™ç‚¹æ—¶é—´
            setTimeout(initCamera, 1000);
        };
    </script>
</body>
</html>