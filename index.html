<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è¡£æœè´´çº¸ç”Ÿæˆå™¨ (å›½å†…åŠ é€Ÿç‰ˆ)</title>
    <style>
        :root { --primary: #6c5ce7; --bg: #dfe6e9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; min-height: 100vh; }
        .container { width: 100%; max-width: 400px; background: white; padding: 15px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        .camera-wrapper { position: relative; width: 100%; height: 300px; border-radius: 15px; overflow: hidden; background: #000; margin-bottom: 15px; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #resultCanvas { max-width: 100%; height: auto; display: none; margin-top: 10px; background-image: linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%), linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%); background-size: 20px 20px; border-radius: 10px; border: 2px dashed #b2bec3; }
        .btn-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        button { padding: 12px 24px; border: none; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }
        #captureBtn { background: var(--primary); color: white; }
        #downloadBtn { background: #00b894; color: white; display: none; }
        #retryBtn { background: #fab1a0; color: white; display: none; }
        .loader { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; z-index: 10; width: 80%; }
        .tips { font-size: 12px; color: #636e72; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ‘• è¡£æœå˜è´´çº¸ (åŠ é€Ÿç‰ˆ)</h2>
        <div class="camera-wrapper">
            <video id="video" autoplay playsinline muted></video>
            <div id="loader" class="loader"></div>
        </div>
        <canvas id="resultCanvas"></canvas>
        <div class="btn-group">
            <button id="captureBtn" onclick="takePhoto()">ğŸ“· æ‹ç…§å¹¶åˆ¶ä½œ</button>
            <button id="retryBtn" onclick="resetCamera()">ğŸ”„ é‡æ‹</button>
            <button id="downloadBtn" onclick="downloadSticker()">â¬‡ï¸ ä¿å­˜è´´çº¸</button>
        </div>
        <p class="tips">æç¤ºï¼šä½¿ç”¨å›½å†…é•œåƒæºï¼Œé¦–æ¬¡åŠ è½½ä»éœ€æ¶ˆè€—çº¦ 40MB æµé‡ï¼Œè¯·ä¿æŒç½‘ç»œç•…é€šã€‚</p>
    </div>

    <!-- ä¿®æ”¹ç‚¹1ï¼šä½¿ç”¨ é¥¿äº†ä¹ˆCDN åŠ è½½ JS åº“ï¼Œè§£å†³ not defined é—®é¢˜ -->
    <script src="https://npm.elemecdn.com/@imgly/background-removal@1.3.0/dist/imgly-background-removal.min.js"></script>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('resultCanvas');
        const ctx = canvas.getContext('2d');
        const loader = document.getElementById('loader');
        const captureBtn = document.getElementById('captureBtn');
        
        // 1. å¯åŠ¨æ‘„åƒå¤´
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: { ideal: 1280 } } 
                });
                video.srcObject = stream;
                resetButtons(true);
            } catch (err) {
                alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼š" + err.message);
            }
        }

        // 2. æ‹ç…§å¹¶å¤„ç†
        async function takePhoto() {
            loader.style.display = 'block';
            loader.innerHTML = "å‡†å¤‡ä¸­...";
            captureBtn.disabled = true;

            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            tempCanvas.getContext('2d').drawImage(video, 0, 0);
            video.pause();

            try {
                const blob = await new Promise(r => tempCanvas.toBlob(r, 'image/png'));

                // === æ ¸å¿ƒä¿®æ”¹ç‚¹2ï¼šé…ç½®å›½å†…é•œåƒæºä¸‹è½½æ¨¡å‹ ===
                // publicPath æŒ‡å‘é¥¿äº†ä¹ˆ CDN çš„ data åŒ…
                const imageBitmap = await imglyRemoveBackground(blob, {
                    publicPath: 'https://npm.elemecdn.com/@imgly/background-removal-data@1.3.0/dist/',
                    progress: (key, current, total) => {
                        const percent = Math.round((current / total) * 100);
                        loader.innerHTML = `æ­£åœ¨åŠ é€Ÿä¸‹è½½æ¨¡å‹...<br>${percent}%`;
                    }
                });

                await drawStickerEffect(imageBitmap);
                
                video.style.display = 'none';
                canvas.style.display = 'block';
                resetButtons(false);
            } catch (error) {
                console.error(error);
                alert('å¤±è´¥ï¼š' + error.message + '\nè¯·å°è¯•åˆ‡æ¢ Wi-Fi æˆ–æ•°æ®ç½‘ç»œã€‚');
                video.play();
            } finally {
                loader.style.display = 'none';
                captureBtn.disabled = false;
            }
        }

        // 3. ç»˜åˆ¶è´´çº¸
        async function drawStickerEffect(imageBlob) {
            const img = new Image();
            img.src = URL.createObjectURL(imageBlob);
            await new Promise(r => img.onload = r);
            canvas.width = img.width;
            canvas.height = img.height;
            
            ctx.filter = 'saturate(1.2) contrast(1.1)';
            // ç»˜åˆ¶ç™½è¾¹
            const border = 15;
            ctx.shadowColor = 'white';
            ctx.shadowBlur = 0;
            const steps = 8;
            for(let i=0; i<steps; i++) {
                const a = (i/steps)*2*Math.PI;
                ctx.shadowOffsetX = Math.cos(a)*border;
                ctx.shadowOffsetY = Math.sin(a)*border;
                ctx.drawImage(img, 0, 0);
            }
            ctx.shadowColor = 'transparent';
            ctx.filter = 'none';
            ctx.drawImage(img, 0, 0);
        }

        function resetButtons(isCam) {
            document.getElementById('captureBtn').style.display = isCam ? 'inline-block' : 'none';
            document.getElementById('downloadBtn').style.display = isCam ? 'none' : 'inline-block';
            document.getElementById('retryBtn').style.display = isCam ? 'none' : 'inline-block';
        }
        function resetCamera() {
            video.style.display = 'block';
            canvas.style.display = 'none';
            video.play();
            resetButtons(true);
        }
        function downloadSticker() {
            const link = document.createElement('a');
            link.download = `sticker-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }
        window.onload = startCamera;
    </script>
</body>
</html>