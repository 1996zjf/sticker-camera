<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¤ç‰ˆ - è´´çº¸ç›¸æœº</title>
    <style>
        :root { --primary: #6c5ce7; --bg: #dfe6e9; }
        body { font-family: sans-serif; background: var(--bg); padding: 10px; text-align: center; }
        
        #debug-log {
            width: 90%; height: 120px; background: #2d3436; color: #fab1a0;
            font-family: monospace; font-size: 12px; overflow-y: scroll;
            text-align: left; padding: 10px; margin: 10px auto;
            border-radius: 8px; border: 1px solid #ccc;
        }

        .camera-wrapper { 
            position: relative; width: 100%; height: 350px; 
            background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 10px;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        #resultCanvas { max-width: 100%; height: auto; display: none; border-radius: 10px; border: 2px dashed #b2bec3; }

        button { 
            padding: 12px 20px; margin: 5px; border: none; border-radius: 5px; 
            font-size: 16px; font-weight: bold; background: var(--primary); color: white; 
        }
        button:disabled { background: #b2bec3; }
        
        #status { margin-bottom: 5px; font-weight: bold; color: #d63031; }
        .ready { color: #00b894 !important; }
    </style>
</head>
<body>
    <h3>ğŸš€ æœ€ç»ˆä¿®å¤ç‰ˆ</h3>
    <div id="status">ğŸ”´ è¿æ¥å®˜æ–¹æ•°æ®æº...</div>
    
    <div class="camera-wrapper">
        <video id="video" autoplay playsinline muted></video>
    </div>
    <canvas id="resultCanvas"></canvas>

    <div>
        <button id="startCamBtn" onclick="initCamera()">ğŸ¥ å¯åŠ¨æ‘„åƒå¤´</button>
        <button id="captureBtn" onclick="handleCapture()" disabled>ğŸ“¸ æ‹ç…§</button>
        <button onclick="location.reload()">ğŸ”„ åˆ·æ–°</button>
    </div>

    <div id="debug-log">æ—¥å¿—åŒº ready...<br></div>

    <!-- æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ -->
    <script type="module">
        // JS åº“ä¾ç„¶ç”¨ esm.shï¼Œå› ä¸ºå®ƒå¾ˆå¿«ä¸”æ²¡é—®é¢˜
        import imglyRemoveBackground from 'https://esm.sh/@imgly/background-removal@1.3.0';

        function log(msg) {
            const box = document.getElementById('debug-log');
            const time = new Date().toLocaleTimeString();
            box.innerHTML += `[${time}] ${msg}<br>`;
            box.scrollTop = box.scrollHeight;
            console.log(msg);
        }
        window.logToScreen = log;

        window.runAI = async (blob) => {
            log("ğŸš€ è¯·æ±‚å®˜æ–¹æ•°æ®æº (static.img.ly)...");
            
            return await imglyRemoveBackground(blob, {
                // ã€å…³é”®ä¿®æ”¹ã€‘æ¢å›å®˜æ–¹æºï¼Œç¡®ä¿æ–‡ä»¶ç»“æ„æ­£ç¡®
                // å¦‚æœè¿™ä¸ªè¿˜æ…¢ï¼Œå”¯ä¸€çš„åŠæ³•å°±æ˜¯ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°äº†
                publicPath: 'https://static.img.ly/background-removal-data/1.3.0/', 
                debug: true,
                progress: (key, current, total) => {
                   // åªæœ‰å½“ä¸‹è½½æ–°æ–‡ä»¶æ—¶æ‰æ‰“å°ï¼Œé¿å…åˆ·å±
                   const percent = Math.round((current / total) * 100);
                   if (percent % 20 === 0 || percent === 100) {
                       log(`ğŸ“¦ ä¸‹è½½æ¨¡å‹ ${key}: ${percent}%`);
                   }
                }
            });
        };

        const status = document.getElementById('status');
        status.innerText = "ğŸŸ¢ AI å¼•æ“å°±ç»ª";
        status.classList.add('ready');
        log("âœ… JSåº“åŠ è½½æˆåŠŸï¼Œç­‰å¾…æ‹ç…§è§¦å‘æ•°æ®ä¸‹è½½");
    </script>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('resultCanvas');
        const ctx = canvas.getContext('2d');
        const captureBtn = document.getElementById('captureBtn');
        const startCamBtn = document.getElementById('startCamBtn');

        function debug(msg) { if(window.logToScreen) window.logToScreen(msg); }

        async function initCamera() {
            debug("ğŸ”„ æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...");
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: { ideal: 1280 } } 
                });
                video.srcObject = stream;
                video.play().then(() => {
                    debug("â–¶ï¸ è§†é¢‘æµæ­£å¸¸");
                    startCamBtn.style.display = 'none';
                    captureBtn.disabled = false;
                });
            } catch (err) {
                debug("âŒ æ‘„åƒå¤´å¤±è´¥: " + err.message);
                alert("è¯·å…è®¸æ‘„åƒå¤´æƒé™ï¼");
            }
        }

        async function handleCapture() {
            if (!window.runAI) return alert("AIæœªåŠ è½½");
            
            captureBtn.disabled = true;
            captureBtn.innerText = "æ­£åœ¨ä¸‹è½½æ¨¡å‹(è€—æ—¶)...";
            debug("ğŸ“· æ‹ç…§ï¼Œå‡†å¤‡ä¸‹è½½æ¨¡å‹...");

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            try {
                const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
                
                // è¿™ä¸€æ­¥ä¼šå»å®˜æ–¹åœ°å€ä¸‹è½½æ•°æ®ï¼Œå¯èƒ½ä¼šæ…¢ï¼Œä½†ä¸ä¼šæŠ¥ Metadata é”™è¯¯
                const imageBitmap = await window.runAI(blob);
                
                debug("âœ¨ æŠ å›¾æˆåŠŸï¼å¤„ç†ç‰¹æ•ˆ...");
                await drawSticker(imageBitmap);
                
                video.style.display = 'none';
                canvas.style.display = 'block';
                captureBtn.style.display = 'none';
                debug("âœ… å…¨éƒ¨å®Œæˆï¼");
            } catch (error) {
                debug("âŒ å¤±è´¥: " + error.message);
                // å¦‚æœè¿™é‡Œæ˜¯ Network Errorï¼Œé‚£å°±çœŸçš„åªèƒ½ç”¨â€œæœ¬åœ°æ–‡ä»¶å¤§æ³•â€äº†
                if(error.message.includes('fetch') || error.message.includes('Network')) {
                    alert("ç½‘ç»œä¸‹è½½å¤±è´¥ã€‚è¯·çœ‹ä¸‹æ–‡å»ºè®®ã€‚");
                } else {
                    alert("å‡ºé”™: " + error.message);
                }
                captureBtn.disabled = false;
                captureBtn.innerText = "é‡è¯•";
            }
        }

        async function drawSticker(imageBitmap) {
            const img = imageBitmap;
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.filter = 'saturate(1.2) contrast(1.1)';
            const border = Math.max(10, img.width * 0.02);
            ctx.shadowColor = 'white';
            ctx.shadowBlur = 0;
            const steps = 8;
            for(let i=0; i<steps; i++) {
                const a = (i/steps)*2*Math.PI;
                ctx.shadowOffsetX = Math.cos(a)*border;
                ctx.shadowOffsetY = Math.sin(a)*border;
                ctx.drawImage(img, 0, 0);
            }
            ctx.shadowColor = 'transparent';
            ctx.filter = 'none';
            ctx.drawImage(img, 0, 0);
        }

        window.onload = () => setTimeout(initCamera, 1000);
    </script>
</body>
</html>