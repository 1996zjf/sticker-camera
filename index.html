<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI æŠ å›¾ (æœ€ç»ˆä¿®å¤ç‰ˆ)</title>
    <style>
        body { background: #2d3436; color: white; margin: 0; padding: 10px; font-family: sans-serif; text-align: center; }
        .camera-wrapper { 
            width: 100%; max-width: 600px; height: 60vh; background: #000; 
            margin: 10px auto; border-radius: 12px; overflow: hidden; position: relative; 
            border: 2px solid #6c5ce7;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { max-width: 100%; display: none; border-radius: 12px; }
        
        #console-box {
            position: fixed; bottom: 0; left: 0; right: 0; height: 150px;
            background: rgba(0, 0, 0, 0.9); color: #fab1a0;
            font-family: monospace; font-size: 12px; padding: 10px;
            overflow-y: scroll; text-align: left; z-index: 9999; border-top: 2px solid #6c5ce7;
        }
        .btn { padding: 15px 40px; font-size: 18px; border-radius: 50px; background: #6c5ce7; color: white; border: none; font-weight: bold; margin-bottom: 160px; }
        .btn:disabled { background: #636e72; }
    </style>

    <!-- === å…³é”®ä¿®å¤ï¼šè¡¥å…¨ç¼ºå¤±çš„ä¾èµ– (å›½å†…æº) === -->
    <script type="importmap">
    {
        "imports": {
            "lodash": "https://npm.elemecdn.com/lodash-es@4.17.21/lodash.js",
            "onnxruntime-web": "https://npm.elemecdn.com/onnxruntime-web@1.15.1/dist/ort.es6.min.js"
        }
    }
    </script>
</head>
<body>
    <h3>ğŸ§ª ä¾èµ–æ³¨å…¥æ¨¡å¼</h3>
    <div class="camera-wrapper">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="resultCanvas"></canvas>
    </div>
    <button id="captureBtn" class="btn" onclick="runCapture()">ğŸ“¸ æ‹ç…§</button>
    <div id="console-box">æ­£åœ¨è¿æ¥æœ¬åœ°æ–‡ä»¶...<br></div>

    <script>
        const logBox = document.getElementById('console-box');
        function log(msg, color = '#fab1a0') {
            logBox.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }
        window.appLog = log;
    </script>

    <!-- === æ ¸å¿ƒé€»è¾‘ï¼šåŠ è½½æœ¬åœ° imgly.js === -->
    <script type="module">
        try {
            log("ğŸ”„ æ­£åœ¨å¯¼å…¥æœ¬åœ° imgly.js...", "#fff");
            
            // è¿™æ¬¡å¯¼å…¥ä¼šåˆ©ç”¨ä¸Šé¢çš„ importmap è‡ªåŠ¨å»ä¸‹è½½ lodash
            import * as Module from './imgly.js';

            // å…¼å®¹æ€§æŸ¥æ‰¾ï¼šä¸åŒçš„æ‰“åŒ…æ–¹å¼å¯¼å‡ºåå¯èƒ½ä¸åŒ
            const mainFn = Module.default || Module.removeBackground || Module.imglyRemoveBackground;

            if (mainFn) {
                window.imglyLib = mainFn;
                log("âœ… æ ¸å¿ƒåº“åŠ è½½æˆåŠŸï¼ä¾èµ–å·²ä¿®å¤ã€‚", "#00b894");
                log("ğŸ‘‰ è¯·ç‚¹å‡»æ‹ç…§æµ‹è¯•", "#00b894");
            } else {
                log("âš ï¸ è­¦å‘Šï¼šJSåŠ è½½äº†ä½†æ‰¾ä¸åˆ°å…¥å£ã€‚", "yellow");
                console.log(Module);
            }

        } catch (e) {
            log("âŒ åŠ è½½å¤±è´¥: " + e.message, "red");
            if (e.message.includes("lodash")) {
                log("æç¤ºï¼šä¾èµ–æ˜ å°„å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œèƒ½å¦è®¿é—® npm.elemecdn.com", "yellow");
            }
        }
    </script>

    <script>
        const video = document.getElementById('video');
        
        // å¯åŠ¨æ‘„åƒå¤´
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(s => video.srcObject = s)
            .catch(e => log("æ‘„åƒå¤´é”™è¯¯: " + e.message, "red"));

        // æ‹ç…§
        window.runCapture = async function() {
            const btn = document.getElementById('captureBtn');
            if (!window.imglyLib) return alert("è¯·ç­‰å¾…åˆå§‹åŒ–å®Œæˆ");

            btn.disabled = true;
            btn.innerText = "åˆ†æä¸­...";
            log("ğŸš€ å¼€å§‹å¤„ç† (è¯»å–æœ¬åœ°æ¨¡å‹)...", "#fff");

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            try {
                const blob = await new Promise(r => canvas.toBlob(r));
                
                const config = {
                    publicPath: './', // å¼ºåˆ¶è¯»å– GitHub ä»“åº“é‡Œçš„ 56 ä¸ªæ–‡ä»¶
                    debug: true,
                    progress: (key, cur, total) => {
                        if(total) log(`ğŸ“¥ è¯»å–: ${Math.round(cur/total*100)}%`, "#aaa");
                    }
                };

                const result = await window.imglyLib(blob, config);
                
                log("âœ¨ æˆåŠŸï¼", "#00b894");
                const resCanvas = document.getElementById('resultCanvas');
                resCanvas.width = result.width;
                resCanvas.height = result.height;
                resCanvas.getContext('2d').drawImage(result, 0, 0);
                
                // æè¾¹
                const ctx = resCanvas.getContext('2d');
                ctx.globalCompositeOperation = 'destination-over';
                ctx.shadowColor = 'white'; ctx.shadowBlur = 0;
                const border = Math.max(5, result.width * 0.015);
                const steps = 8;
                for(let i=0; i<steps; i++) {
                    const a = (i/steps)*2*Math.PI;
                    ctx.shadowOffsetX = Math.cos(a)*border; ctx.shadowOffsetY = Math.sin(a)*border;
                    ctx.drawImage(result, 0, 0);
                }
                ctx.shadowColor = 'transparent';
                ctx.drawImage(result, 0, 0);

                video.style.display = 'none';
                resCanvas.style.display = 'block';
                btn.style.display = 'none';

            } catch(e) {
                console.error(e);
                log("âŒ å¤±è´¥: " + e.message, "red");
                btn.disabled = false;
                btn.innerText = "é‡è¯•";
            }
        }
    </script>
</body>
</html>
