<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è¡£æœè´´çº¸ç”Ÿæˆå™¨</title>
    <style>
        :root {
            --primary: #6c5ce7;
            --bg: #dfe6e9;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        h2 { color: #2d3436; margin-bottom: 10px; }
        
        .container {
            width: 100%;
            max-width: 400px;
            background: white;
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }

        /* è§†é¢‘é¢„è§ˆåŒº */
        .camera-wrapper {
            position: relative;
            width: 100%;
            height: 300px;
            border-radius: 15px;
            overflow: hidden;
            background: #000;
            margin-bottom: 15px;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ç»“æœå±•ç¤ºåŒº */
        #resultCanvas {
            max-width: 100%;
            height: auto;
            display: none; /* é»˜è®¤éšè— */
            margin-top: 10px;
            background-image: linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%), linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            border-radius: 10px;
            border: 2px dashed #b2bec3;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
        }

        button:active { transform: scale(0.95); }

        #captureBtn { background: var(--primary); color: white; }
        #downloadBtn { background: #00b894; color: white; display: none; }
        #retryBtn { background: #fab1a0; color: white; display: none; }

        /* åŠ è½½åŠ¨ç”» */
        .loader {
            display: none;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            z-index: 10;
        }

        .tips {
            font-size: 12px;
            color: #636e72;
            margin-top: 15px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>ğŸ‘• è¡£æœå˜è´´çº¸</h2>
        
        <div class="camera-wrapper">
            <video id="video" autoplay playsinline muted></video>
            <div id="loader" class="loader">æ­£åœ¨AIæŠ å›¾å¹¶ç”Ÿæˆè´´çº¸...<br>é¦–æ¬¡è¿è¡Œéœ€åŠ è½½æ¨¡å‹</div>
        </div>

        <canvas id="resultCanvas"></canvas>

        <div class="btn-group">
            <button id="captureBtn" onclick="takePhoto()">ğŸ“· æ‹ç…§å¹¶åˆ¶ä½œ</button>
            <button id="retryBtn" onclick="resetCamera()">ğŸ”„ é‡æ‹</button>
            <button id="downloadBtn" onclick="downloadSticker()">â¬‡ï¸ ä¿å­˜è´´çº¸</button>
        </div>

        <p class="tips">æç¤ºï¼šè¯·å°†è¡£æœç½®äºç”»é¢ä¸­å¿ƒï¼ŒèƒŒæ™¯å°½é‡å¹²å‡€ã€‚åŸºäºæµè§ˆå™¨æœ¬åœ°è®¡ç®—ï¼Œä¿æŠ¤éšç§ã€‚</p>
    </div>

    <!-- å¼•å…¥å¼ºå¤§çš„å‰ç«¯æŠ å›¾åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.3.0/dist/imgly-background-removal.min.js"></script>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('resultCanvas');
        const ctx = canvas.getContext('2d');
        const loader = document.getElementById('loader');
        const captureBtn = document.getElementById('captureBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const retryBtn = document.getElementById('retryBtn');

        let stream = null;

        // 1. å¯åŠ¨æ‘„åƒå¤´
        async function startCamera() {
            try {
                // ä¼˜å…ˆè¯·æ±‚åç½®æ‘„åƒå¤´
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                video.srcObject = stream;
                video.style.display = 'block';
                canvas.style.display = 'none';
                resetButtons(true);
            } catch (err) {
                alert("æ— æ³•è°ƒç”¨æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™æˆ–ç¡®ä¿ä½¿ç”¨HTTPSè®¿é—®ã€‚\né”™è¯¯: " + err.message);
            }
        }

        // 2. æ‹ç…§å¹¶å¤„ç†
        async function takePhoto() {
            // æ˜¾ç¤ºåŠ è½½ä¸­
            loader.style.display = 'block';
            captureBtn.disabled = true;

            // åˆ›å»ºä¸´æ—¶ Canvas æŠ“å–å½“å‰å¸§
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(video, 0, 0);

            // æš‚åœè§†é¢‘ä»¥è·å¾—â€œå¿«é—¨â€æ„Ÿ
            video.pause();

           try {
                // è½¬æ¢ä¸º Blob ä¾› AI åº“ä½¿ç”¨
                const blob = await new Promise(resolve => tempCanvas.toBlob(resolve, 'image/png'));

                // === æ ¸å¿ƒæ­¥éª¤ï¼šAI å»é™¤èƒŒæ™¯ ===
                // ã€ä¿®æ”¹ç‚¹ã€‘å¢åŠ  publicPath é…ç½®ï¼Œä½¿ç”¨ jsdelivr CDN åŠ é€Ÿæ¨¡å‹ä¸‹è½½
                const imageBitmap = await imglyRemoveBackground(blob, {
                    publicPath: 'https://cdn.jsdelivr.net/npm/@imgly/background-removal-data@1.3.0/dist/', 
                    progress: (key, current, total) => {
                        // è®¡ç®—ç™¾åˆ†æ¯”
                        const percent = Math.round((current / total) * 100);
                        // æ›´æ–°å±å¹•ä¸Šçš„åŠ è½½æç¤º
                        loader.innerHTML = `æ­£åœ¨ä¸‹è½½ AI æ¨¡å‹... ${percent}%<br>è¯·ä¿æŒç½‘ç»œé€šç•…`;
                        console.log(`Downloading ${key}: ${percent}%`);
                    }
                });

                // === æ ¸å¿ƒæ­¥éª¤ï¼šç”Ÿæˆè´´çº¸æ•ˆæœï¼ˆç™½è¾¹ï¼‰ ===
                await drawStickerEffect(imageBitmap);

                // ç•Œé¢çŠ¶æ€æ›´æ–°
                video.style.display = 'none';
                canvas.style.display = 'block';
                resetButtons(false);

            } catch (error) {
                console.error(error);
                // æ‰“å°è¯¦ç»†é”™è¯¯ä»¥ä¾¿æ’æŸ¥
                alert('é”™è¯¯ï¼š' + error.message + '\nå»ºè®®ï¼šè¯·åˆ‡æ¢ Wi-Fi æˆ– 5G å†è¯•ï¼Œé¦–æ¬¡åŠ è½½éœ€è¦ä¸‹è½½çº¦ 40MB æ•°æ®ã€‚');
                video.play();
            }finally {
                loader.style.display = 'none';
                captureBtn.disabled = false;
            }
        }

        // 3. ç»˜åˆ¶è´´çº¸æ•ˆæœï¼ˆåŠ ç²—ç™½è¾¹ + é˜´å½±ï¼‰
        async function drawStickerEffect(imageBlob) {
            const img = new Image();
            img.src = URL.createObjectURL(imageBlob);
            
            await new Promise(r => img.onload = r);

            // è®¾ç½®ç”»å¸ƒå¤§å°
            canvas.width = img.width;
            canvas.height = img.height;

            // A. å¢åŠ é¥±å’Œåº¦/å¯¹æ¯”åº¦ (ç®€å•çš„é£æ ¼åŒ–)
            ctx.filter = 'saturate(1.3) contrast(1.1)';
            
            // B. ç»˜åˆ¶ç™½è¾¹ (Sticker Border)
            // è¿™é‡Œä½¿ç”¨å¤šæ¬¡ç»˜åˆ¶é˜´å½±çš„ Hack æ–¹æ³•æ¥æ¨¡æ‹Ÿæè¾¹
            // è¿™ç§æ–¹æ³•æ¯”å¤„ç†åƒç´ æ•°æ®å¿«ä¸”ç®€å•
            const borderThickness = 15; // è¾¹æ¡†åšåº¦
            
            ctx.shadowColor = 'white';
            ctx.shadowBlur = 0;
            
            // åœ¨8ä¸ªæ–¹å‘ç»˜åˆ¶ç™½è‰²æŠ•å½±ï¼Œå½¢æˆå®å¿ƒè¾¹æ¡†
            const steps = 8;
            for(let i=0; i<steps; i++) {
                const angle = (i / steps) * 2 * Math.PI;
                const x = Math.cos(angle) * borderThickness;
                const y = Math.sin(angle) * borderThickness;
                ctx.shadowOffsetX = x;
                ctx.shadowOffsetY = y;
                // å¤šç”»å‡ æ¬¡ä»¥åŠ æ·±ä¸é€æ˜åº¦
                ctx.drawImage(img, 0, 0);
                ctx.drawImage(img, 0, 0); 
            }

            // C. æ¸…é™¤é˜´å½±è®¾ç½®ï¼Œç»˜åˆ¶åŸå›¾åœ¨ä¸­é—´
            ctx.shadowColor = 'transparent';
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
            ctx.filter = 'none'; // é‡ç½®æ»¤é•œï¼Œæˆ–è€…ä¿ç•™ä¸Šé¢çš„æ»¤é•œ
            
            // ä¸ºäº†è®©åŸå›¾ç›–ä½è¾¹æ¡†å†…éƒ¨çš„æ‚è‰²ï¼Œæœ€åå†ç”»ä¸€æ¬¡åŸå›¾
            ctx.drawImage(img, 0, 0);
            
            // D. åŠ ä¸Šä¸€ç‚¹è½»å¾®çš„å¤–éƒ¨æŠ•å½±ï¼ˆè´´çº¸çš„ç«‹ä½“æ„Ÿï¼‰
            // ç”±äº Canvas ä¸»è¦æ˜¯ä½å›¾ï¼Œè¦åŠ å¤–éƒ¨æŠ•å½±æœ€å¥½æ˜¯ä¿ç•™ç°åœ¨çš„ Canvasï¼Œ
            // å†å»ºä¸€ä¸ªæ–° Canvas ç”»ç°åœ¨çš„å›¾å¹¶åŠ é˜´å½±ï¼Œè¿™é‡Œä¸ºäº†ç®€å•çœç•¥ã€‚
        }

        function resetButtons(isCameraMode) {
            if (isCameraMode) {
                captureBtn.style.display = 'inline-block';
                downloadBtn.style.display = 'none';
                retryBtn.style.display = 'none';
            } else {
                captureBtn.style.display = 'none';
                downloadBtn.style.display = 'inline-block';
                retryBtn.style.display = 'inline-block';
            }
        }

        function resetCamera() {
            video.style.display = 'block';
            canvas.style.display = 'none';
            video.play();
            resetButtons(true);
        }

        function downloadSticker() {
            const link = document.createElement('a');
            link.download = `sticker-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', startCamera);
    </script>
</body>
</html>