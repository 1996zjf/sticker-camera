<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æŠ å›¾ v1.4+ (å“ˆå¸Œæ–‡ä»¶ç‰ˆ)</title>
    <style>
        body { font-family: sans-serif; background: #2d3436; color: white; text-align: center; padding: 10px; margin: 0; height: 100vh; display: flex; flex-direction: column; }
        .camera-wrapper { flex: 1; background: #000; margin-bottom: 10px; overflow: hidden; border-radius: 12px; position: relative; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { max-width: 100%; max-height: 100%; object-fit: contain; display: none; }
        .controls { height: 80px; display: flex; justify-content: center; align-items: center; gap: 15px; }
        button { padding: 15px 30px; background: #6c5ce7; color: white; border: none; border-radius: 50px; font-size: 18px; font-weight: bold; transition: 0.2s; }
        button:disabled { background: #636e72; color: #b2bec3; }
        #debug-log { text-align: left; background: rgba(0,0,0,0.5); color: #00b894; padding: 10px; height: 100px; overflow-y: auto; font-size: 11px; position: absolute; top: 10px; left: 10px; right: 10px; pointer-events: none; border-radius: 8px; }
    </style>
</head>
<body>
    <div id="debug-log">åˆå§‹åŒ– v1.4+ æ¨¡å¼...<br></div>

    <div class="camera-wrapper">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="resultCanvas"></canvas>
    </div>

    <div class="controls">
        <button id="captureBtn" onclick="window.handleCapture()">ğŸ“¸ æ‹ç…§</button>
        <button onclick="location.reload()" style="background:#fab1a0; font-size:14px; padding:10px 20px;">ğŸ”„</button>
    </div>

    <!-- ä½¿ç”¨ module æ–¹å¼å¼•å…¥æ”¹ååçš„ imgly.js -->
     <script type="module">
        // 1. æŠŠæ•´ä¸ªæ–‡ä»¶ä½œä¸ºå¯¹è±¡å¯¼å…¥
        import * as ImglyModule from './imgly.js';

        // 2. è‡ªåŠ¨å¯»æ‰¾çœŸæ­£çš„å…¥å£å‡½æ•°
        // æ–°ç‰ˆå¯èƒ½æ˜¯ .removeBackgroundï¼Œä¹Ÿå¯èƒ½æ˜¯ .defaultï¼Œæˆ‘ä»¬éƒ½è¯•è¯•
        const entryFn = ImglyModule.removeBackground || ImglyModule.default || ImglyModule.imglyRemoveBackground;

        const logBox = document.getElementById('debug-log');
        // å®šä¹‰å…¨å±€æ—¥å¿—å‡½æ•°
        window.log = (msg) => {
            if(logBox) {
                logBox.innerHTML += `> ${msg}<br>`;
                logBox.scrollTop = logBox.scrollHeight;
            }
            console.log(msg);
        };

        // 3. æ£€æŸ¥å¹¶æŒ‚è½½
        if (entryFn) {
            window.imglyLib = entryFn;
            window.log("âœ… æˆåŠŸæ‰¾åˆ°æ ¸å¿ƒå‡½æ•°ï¼");
            window.log("ğŸ“‚ æ¨¡å—å¯¼å‡ºå†…å®¹: " + Object.keys(ImglyModule).join(', '));
        } else {
            window.log("âŒ åŠ è½½äº† imgly.js ä½†æ²¡æ‰¾åˆ°å…¥å£å‡½æ•°");
            window.log("âš ï¸ æ¨¡å—å†…å®¹: " + JSON.stringify(ImglyModule));
            alert("JS åŠ è½½å¼‚å¸¸ï¼Œè¯·æˆªå›¾å‘ç»™å¼€å‘è€…ï¼ˆçœ‹å±å¹•æ—¥å¿—ï¼‰");
        }
    </script>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('resultCanvas');
        const ctx = canvas.getContext('2d');
        const btn = document.getElementById('captureBtn');

        // 1. å¯åŠ¨æ‘„åƒå¤´
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1920 } } })
            .then(stream => { video.srcObject = stream; })
            .catch(err => window.log && window.log("âŒ æ‘„åƒå¤´å¤±è´¥: " + err.message));

        // 2. æ‹ç…§é€»è¾‘
        window.handleCapture = async function() {
            if (!window.imglyLib) return alert("JS æ–‡ä»¶æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ imgly.js");

            btn.disabled = true;
            btn.innerText = "è®¡ç®—ä¸­...";
            window.log("ğŸš€ å¼€å§‹å¤„ç†...");

            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            tempCanvas.getContext('2d').drawImage(video, 0, 0);
            const blob = await new Promise(r => tempCanvas.toBlob(r));

            try {
                // æ–°ç‰ˆæ ¸å¿ƒé…ç½®
                const config = {
                    publicPath: './', // å…³é”®ï¼šè®©å®ƒåœ¨å½“å‰ç›®å½•æ‰¾ resources.json
                    debug: true,
                    progress: (key, current, total) => {
                        // è¿™é‡Œ key å¯èƒ½ä¼šæ˜¾ç¤ºæˆä¹±ç æ–‡ä»¶åï¼Œæ˜¯æ­£å¸¸çš„
                        if (total) {
                            const p = Math.round(current / total * 100);
                            if(p % 20 === 0) window.log(`ğŸ“¥ ä¸‹è½½èµ„æº: ${p}%`);
                        }
                    }
                };

                // æ‰§è¡Œ
                const imageBitmap = await window.imglyLib(blob, config);
                
                window.log("âœ¨ æˆåŠŸï¼ç»˜åˆ¶ç»“æœ...");
                canvas.width = imageBitmap.width;
                canvas.height = imageBitmap.height;
                
                // ç®€å•æè¾¹
                ctx.shadowColor = 'white'; ctx.shadowBlur = 0;
                const steps = 10; const border = Math.max(5, imageBitmap.width * 0.015);
                for(let i=0; i<steps; i++) {
                    const a = (i/steps)*2*Math.PI;
                    ctx.shadowOffsetX = Math.cos(a)*border; ctx.shadowOffsetY = Math.sin(a)*border;
                    ctx.drawImage(imageBitmap, 0, 0);
                }
                ctx.shadowColor = 'transparent';
                ctx.drawImage(imageBitmap, 0, 0);
                
                video.style.display = 'none';
                canvas.style.display = 'block';
                btn.style.display = 'none';
                window.log("âœ… å®Œæˆ");

            } catch (error) {
                console.error(error);
                window.log("âŒ å¤±è´¥: " + error.message);
                if(error.message.includes("fetch") || error.message.includes("404")) {
                    alert("æ–‡ä»¶ç¼ºå¤±ï¼\nè¯·ç¡®ä¿æˆªå›¾é‡Œçš„æ‰€æœ‰ä¹±ç æ–‡ä»¶å’Œ resources.json éƒ½ä¸Šä¼ åˆ°äº† GitHubã€‚");
                }
                btn.disabled = false;
                btn.innerText = "é‡è¯•";
            }
        }
    </script>
</body>
</html>
