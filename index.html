<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¿®å¤ç‰ˆ - AI æŠ å›¾</title>
    <style>
        body { background: #2d3436; color: white; margin: 0; padding: 10px; font-family: sans-serif; text-align: center; }
        .camera-wrapper { 
            width: 100%; max-width: 600px; height: 60vh; background: #000; 
            margin: 10px auto; border-radius: 12px; overflow: hidden; position: relative; 
            border: 2px solid #6c5ce7;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { max-width: 100%; display: none; border-radius: 12px; }
        
        #console-box {
            position: fixed; bottom: 0; left: 0; right: 0; height: 180px;
            background: rgba(0, 0, 0, 0.9); color: #fab1a0;
            font-family: monospace; font-size: 12px; padding: 10px;
            overflow-y: scroll; text-align: left; z-index: 9999; border-top: 2px solid #6c5ce7;
        }
        .btn { padding: 15px 40px; font-size: 18px; border-radius: 50px; background: #6c5ce7; color: white; border: none; font-weight: bold; margin-bottom: 200px; }
        .btn:disabled { background: #636e72; }
    </style>
</head>
<body>
    <h3>ğŸ•µï¸ æ–‡ä»¶è‡ªæ£€æ¨¡å¼</h3>
    <div class="camera-wrapper">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="resultCanvas"></canvas>
    </div>
    <button id="captureBtn" class="btn" onclick="runCapture()">ğŸ“¸ æ‹ç…§</button>
    <div id="console-box">ç³»ç»Ÿå¯åŠ¨...<br></div>

    <script>
        // 1. æ—¥å¿—å·¥å…·
        const logBox = document.getElementById('console-box');
        function log(msg, color = '#fab1a0') {
            logBox.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }
        window.appLog = log;

        // 2. ä¾¦æ¢é€»è¾‘ï¼šæ£€æŸ¥ imgly.js åˆ°åº•æ˜¯å•¥
        async function checkAndLoad() {
            log("ğŸ” ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥ imgly.js æ–‡ä»¶çŠ¶æ€...", "#fff");
            try {
                const response = await fetch('./imgly.js');
                
                if (response.status === 404) {
                    throw new Error("âŒ æ–‡ä»¶ä¸å­˜åœ¨ (404)ã€‚è¯·æ£€æŸ¥æ˜¯å¦å·²ä¸Šä¼  imgly.js");
                }
                
                const text = await response.text();
                log(`ğŸ“„ æ–‡ä»¶å¤§å°: ${text.length} å­—ç¬¦`, "#fff");

                // æ£€æŸ¥æ˜¯ä¸æ˜¯ HTML (ä¹Ÿå°±æ˜¯ 404 é¡µé¢æˆ– GitHub é¡µé¢)
                if (text.trim().startsWith('<')) {
                    throw new Error("âŒ imgly.js å†…å®¹é”™è¯¯ï¼\nå®ƒçœ‹èµ·æ¥åƒ HTML ç½‘é¡µï¼Œè€Œä¸æ˜¯ JS ä»£ç ã€‚\nåŸå› ï¼šä½ å¯èƒ½ç›´æ¥ä¿å­˜äº† GitHub ç½‘é¡µé“¾æ¥ï¼Œè€Œä¸æ˜¯æ–‡ä»¶å†…å®¹ã€‚");
                }

                log("âœ… æ–‡ä»¶æ ¡éªŒé€šè¿‡ï¼šçœ‹èµ·æ¥æ˜¯ JS ä»£ç ", "#00b894");
                log("ğŸ”„ ç¬¬äºŒæ­¥ï¼šå°è¯•åŠ¨æ€åŠ è½½...", "#fff");

                // 3. åŠ¨æ€å¯¼å…¥ (å…¼å®¹æ€§æœ€å¥½)
                const module = await import('./imgly.js');
                
                // å¯»æ‰¾å…¥å£
                window.imglyLib = module.default || module.imglyRemoveBackground || module.removeBackground;
                
                if (window.imglyLib) {
                    log("ğŸ‰ åŠ è½½æˆåŠŸï¼AI å¼•æ“å°±ç»ªã€‚", "#00b894");
                    log("ğŸ‘‰ ç°åœ¨ç‚¹å‡»æ‹ç…§è¯•è¯•ï¼", "#00b894");
                } else {
                    log("âš ï¸ è­¦å‘Šï¼šæ¨¡å—åŠ è½½äº†ï¼Œä½†æ²¡æ‰¾åˆ°å…¥å£å‡½æ•°ã€‚", "yellow");
                    console.log(module);
                }

            } catch (e) {
                log("âŒ è‡´å‘½é”™è¯¯: " + e.message, "red");
                if(e.message.includes("Failed to fetch")) {
                    log("æç¤ºï¼šæ— æ³•è¯»å–æœ¬åœ°æ–‡ä»¶ï¼Œè¯·ç¡®ä¿å·²ä¸Šä¼ åˆ° GitHub Pages å¹¶é€šè¿‡ https è®¿é—®", "yellow");
                }
            }
        }

        // å¯åŠ¨æ£€æŸ¥
        checkAndLoad();

        // å¯åŠ¨æ‘„åƒå¤´
        const video = document.getElementById('video');
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(s => video.srcObject = s)
            .catch(e => log("æ‘„åƒå¤´é”™è¯¯: " + e.message, "red"));

        // æ‹ç…§é€»è¾‘
        window.runCapture = async function() {
            const btn = document.getElementById('captureBtn');
            if (!window.imglyLib) return alert("AI åº“æœªåŠ è½½ï¼Œè¯·çœ‹åº•éƒ¨æ—¥å¿—");

            btn.disabled = true;
            btn.innerText = "åˆ†æä¸­...";
            log("ğŸš€ å¼€å§‹å¤„ç†...", "#fff");

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            try {
                const blob = await new Promise(r => canvas.toBlob(r));
                
                const config = {
                    publicPath: './', // å¯»æ‰¾ resources.json
                    debug: true,
                    progress: (key, cur, total) => {
                        if(total) log(`ğŸ“¥ åŠ è½½èµ„æº: ${Math.round(cur/total*100)}%`, "#aaa");
                    }
                };

                const result = await window.imglyLib(blob, config);
                
                log("âœ¨ æˆåŠŸï¼", "#00b894");
                const resCanvas = document.getElementById('resultCanvas');
                resCanvas.width = result.width;
                resCanvas.height = result.height;
                resCanvas.getContext('2d').drawImage(result, 0, 0);
                
                video.style.display = 'none';
                resCanvas.style.display = 'block';
                btn.style.display = 'none';

            } catch(e) {
                log("âŒ å¤±è´¥: " + e.message, "red");
                btn.disabled = false;
                btn.innerText = "é‡è¯•";
            }
        }
    </script>
</body>
</html>
