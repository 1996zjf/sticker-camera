<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI æŠ å›¾ (æ··åˆåŠ é€Ÿç‰ˆ)</title>
    <style>
        body { background: #2d3436; color: white; margin: 0; padding: 10px; font-family: sans-serif; text-align: center; }
        .camera-wrapper { 
            width: 100%; max-width: 600px; height: 60vh; background: #000; 
            margin: 10px auto; border-radius: 12px; overflow: hidden; position: relative; 
            border: 2px solid #6c5ce7;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { max-width: 100%; display: none; border-radius: 12px; }
        
        #console-box {
            position: fixed; bottom: 0; left: 0; right: 0; height: 150px;
            background: rgba(0, 0, 0, 0.9); color: #fab1a0;
            font-family: monospace; font-size: 12px; padding: 10px;
            overflow-y: scroll; text-align: left; z-index: 9999; border-top: 2px solid #6c5ce7;
        }
        .btn { padding: 15px 40px; font-size: 18px; border-radius: 50px; background: #6c5ce7; color: white; border: none; font-weight: bold; margin-bottom: 160px; }
        .btn:disabled { background: #636e72; }
    </style>
</head>
<body>
    <h3>ğŸš€ æ··åˆåŠ è½½æ¨¡å¼</h3>
    <div class="camera-wrapper">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="resultCanvas"></canvas>
    </div>
    <button id="captureBtn" class="btn" onclick="runCapture()">ğŸ“¸ æ‹ç…§</button>
    <div id="console-box">åˆå§‹åŒ–...<br></div>

    <script>
        // æ—¥å¿—å·¥å…·
        const logBox = document.getElementById('console-box');
        function log(msg, color = '#fab1a0') {
            logBox.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }
        window.appLog = log;
    </script>

    <!-- === å…³é”®ä¿®æ”¹ï¼šä» esm.sh åŠ è½½è‡ªå¸¦ä¾èµ–çš„ JS === -->
    <script type="module">
        try {
            log("â˜ï¸ æ­£åœ¨ä»ç½‘ç»œåŠ è½½ä¸»ç¨‹åº (esm.sh)...", "#fff");
            
            // ä½¿ç”¨ 1.4.0 ç‰ˆæœ¬ä»¥åŒ¹é…ä½ çš„æœ¬åœ°æ•°æ®
            import imglyRemoveBackground from 'https://esm.sh/@imgly/background-removal@1.4.0';
            
            window.imglyLib = imglyRemoveBackground;
            log("âœ… JS ä¸»ç¨‹åºåŠ è½½æˆåŠŸï¼", "#00b894");
            log("ğŸ“‚ æ¨¡å‹æ•°æ®å°†ä»ã€æœ¬åœ° GitHubã€‘è¯»å–", "#00b894");

        } catch (e) {
            log("âŒ JS åŠ è½½å¤±è´¥: " + e.message, "red");
            log("è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥", "red");
        }
    </script>

    <script>
        const video = document.getElementById('video');
        
        // å¯åŠ¨æ‘„åƒå¤´
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(s => video.srcObject = s)
            .catch(e => log("æ‘„åƒå¤´é”™è¯¯: " + e.message, "red"));

        // æ‹ç…§é€»è¾‘
        window.runCapture = async function() {
            const btn = document.getElementById('captureBtn');
            if (!window.imglyLib) return alert("JS åº“åŠ è½½ä¸­æˆ–å¤±è´¥ï¼Œè¯·çœ‹æ—¥å¿—");

            btn.disabled = true;
            btn.innerText = "æ­£åœ¨è¯»å–æœ¬åœ°æ¨¡å‹...";
            log("ğŸš€ å¼€å§‹å¤„ç†...", "#fff");

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            try {
                const blob = await new Promise(r => canvas.toBlob(r));
                
                const config = {
                    // ã€æ ¸å¿ƒé…ç½®ã€‘å‘Šè¯‰å®ƒå»å½“å‰ GitHub æ–‡ä»¶å¤¹æ‰¾é‚£ 56 ä¸ªæ–‡ä»¶
                    publicPath: './', 
                    debug: true,
                    progress: (key, cur, total) => {
                        // key å¯èƒ½æ˜¯ä¹±ç æ–‡ä»¶åï¼Œæ­£å¸¸
                        if(total) log(`ğŸ“¥ è¯»å–æœ¬åœ°æ–‡ä»¶: ${Math.round(cur/total*100)}%`, "#aaa");
                    }
                };

                const result = await window.imglyLib(blob, config);
                
                log("âœ¨ æˆåŠŸï¼", "#00b894");
                const resCanvas = document.getElementById('resultCanvas');
                resCanvas.width = result.width;
                resCanvas.height = result.height;
                resCanvas.getContext('2d').drawImage(result, 0, 0);
                
                // ç®€å•æè¾¹ç‰¹æ•ˆ
                const ctx = resCanvas.getContext('2d');
                ctx.globalCompositeOperation = 'destination-over';
                ctx.shadowColor = 'white'; ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 4; ctx.shadowOffsetY = 4;
                for(let i=0; i<4; i++) ctx.drawImage(result, 0, 0);

                video.style.display = 'none';
                resCanvas.style.display = 'block';
                btn.style.display = 'none';

            } catch(e) {
                log("âŒ å¤±è´¥: " + e.message, "red");
                btn.disabled = false;
                btn.innerText = "é‡è¯•";
                
                if(e.message.includes("404") || e.message.includes("fetch")) {
                    log("ğŸ’¡ æç¤ºï¼šæ— æ³•æ‰¾åˆ°æœ¬åœ°æ¨¡å‹æ–‡ä»¶ã€‚", "yellow");
                    log("è¯·æ£€æŸ¥ GitHub ä»“åº“é‡Œæ˜¯å¦çœŸçš„æœ‰ resources.json å’Œé‚£äº›ä¹±ç æ–‡ä»¶ã€‚", "yellow");
                }
            }
        }
    </script>
</body>
</html>
